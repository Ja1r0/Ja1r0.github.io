<!DOCTYPE html>












  


<html class="theme-next mist use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">


























<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=7.0.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-cat.png?v=7.0.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-cat.png?v=7.0.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-cat.png?v=7.0.0">


  <link rel="mask-icon" href="/images/logo.svg?v=7.0.0" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '7.0.0',
    sidebar: {"position":"left","display":"always","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false,"dimmer":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="参考链接.用TensorFlow，将本地图片文件，制作为TFRecords文件的数据集，并读取。">
<meta name="keywords" content="TensorFlow">
<meta property="og:type" content="article">
<meta property="og:title" content="创建与读取TFRecords文件">
<meta property="og:url" content="http://yoursite.com/2019/03/20/创建与读取TFRecords文件/index.html">
<meta property="og:site_name" content="Jairo">
<meta property="og:description" content="参考链接.用TensorFlow，将本地图片文件，制作为TFRecords文件的数据集，并读取。">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://yoursite.com/2019/03/20/创建与读取TFRecords文件/1.jpg">
<meta property="og:image" content="http://yoursite.com/2019/03/20/创建与读取TFRecords文件/2.jpg">
<meta property="og:image" content="http://yoursite.com/2019/03/20/创建与读取TFRecords文件/3.jpg">
<meta property="og:image" content="http://yoursite.com/2019/03/20/创建与读取TFRecords文件/4.jpg">
<meta property="og:updated_time" content="2019-03-24T03:51:56.132Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="创建与读取TFRecords文件">
<meta name="twitter:description" content="参考链接.用TensorFlow，将本地图片文件，制作为TFRecords文件的数据集，并读取。">
<meta name="twitter:image" content="http://yoursite.com/2019/03/20/创建与读取TFRecords文件/1.jpg">






  <link rel="canonical" href="http://yoursite.com/2019/03/20/创建与读取TFRecords文件/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>创建与读取TFRecords文件 | Jairo</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Jairo</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>

      
      
    </ul>
  

  
    

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/03/20/创建与读取TFRecords文件/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jairo">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar_square.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jairo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">创建与读取TFRecords文件

              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-03-20 21:05:30" itemprop="dateCreated datePublished" datetime="2019-03-20T21:05:30+08:00">2019-03-20</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-03-24 11:51:56" itemprop="dateModified" datetime="2019-03-24T11:51:56+08:00">2019-03-24</time>
              
            
          </span>

          

          
            
            
              
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
            
                <span class="post-meta-item-text">评论数：</span>
                <a href="/2019/03/20/创建与读取TFRecords文件/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2019/03/20/创建与读取TFRecords文件/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="post-meta-item-icon">
            <i class="fa fa-eye"></i>
             阅读次数： 
            <span class="busuanzi-value" id="busuanzi_value_page_pv"></span>
            </span>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p><a href="https://my.oschina.net/u/3800567/blog/1637798" target="_blank" rel="noopener">参考链接</a>.用TensorFlow，将本地图片文件，制作为TFRecords文件的数据集，并读取。</p>
<a id="more"></a>
<h1 id="遍历目录及文件"><a href="#遍历目录及文件" class="headerlink" title="遍历目录及文件"></a>遍历目录及文件</h1><p>这个步骤，主要是把所有图片的路径读入三个列表中：<code>training_images</code>、<code>testing_images</code>、<code>validation_images</code>.对应三个集合：训练集、测试集、验证集。流程如下：</p>
<ol>
<li>确定所有子目录（<code>tf.gfile.Walk()</code>）</li>
<li>找出所有图片文件（<code>tf.gfile.Glob()</code>）</li>
<li>对每一个图片文件判断进入哪一个集合</li>
</ol>
<h2 id="确定所有子目录"><a href="#确定所有子目录" class="headerlink" title="确定所有子目录"></a>确定所有子目录</h2><p>在TensorFlow中有函数<code>tf.gfile.Walk()</code>函数可以用来遍历目录下的子目录以及文件。在此记录一下该函数的遍历次序问题，即每次遍历输出的结果是否一致。发现该函数和<code>os.walk()</code>函数的遍历方式是一样的，且每次遍历结果都相同。</p>
<p>每次调用遍历一个目录，返回的结果为一个三元组<code>(root, dirs, files)</code>：</p>
<ul>
<li><code>root</code>：当前所遍历的目录</li>
<li><code>dirs</code>：所遍历目录下，所有的目录名</li>
<li><code>files</code>：所遍历目录下，所有的文件名</li>
</ul>
<p>如下面这个文件树：</p>
<img src="/2019/03/20/创建与读取TFRecords文件/1.jpg">
<p>默认会按照先根目录，后子目录的顺序遍历。如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span>&gt;&gt; [x for x in os.walk('pycode')]</span><br><span class="line">[('pycode', ['tmp', 'tutorial'], ['algo.py', 'log.txt', 'paper.py', 'StringConta</span><br><span class="line">in.py', 'tf_test.py']), ('pycode\\tmp', [], ['new 1.py']), ('pycode\\tutorial',</span><br><span class="line">[], ['fabs.py', 'reverse_string.py', 'run.py'])]</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span>&gt;&gt; [x for x in tf.gfile.Walk('pycode')]</span><br><span class="line">[('pycode', ['tmp', 'tutorial'], ['algo.py', 'log.txt', 'paper.py', 'StringConta</span><br><span class="line">in.py', 'tf_test.py']), ('pycode\\tmp', [], ['new 1.py']), ('pycode\\tutorial',</span><br><span class="line">[], ['fabs.py', 'reverse_string.py', 'run.py'])]</span><br></pre></td></tr></table></figure>
<p>当对应参数置为<code>False</code>时，将会按照先子目录，后根目录的顺序遍历。如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span>&gt;&gt; [x for x in os.walk('pycode', topdown=False)]</span><br><span class="line">[('pycode\\tmp', [], ['new 1.py']), ('pycode\\tutorial', [], ['fabs.py', 'revers</span><br><span class="line">e_string.py', 'run.py']), ('pycode', ['tmp', 'tutorial'], ['algo.py', 'log.txt',</span><br><span class="line"> 'paper.py', 'StringContain.py', 'tf_test.py'])]</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span>&gt;&gt; [x for x in tf.gfile.Walk('pycode', in_order=False)]</span><br><span class="line">[('pycode\\tmp', [], ['new 1.py']), ('pycode\\tutorial', [], ['fabs.py', 'revers</span><br><span class="line">e_string.py', 'run.py']), ('pycode', ['tmp', 'tutorial'], ['algo.py', 'log.txt',</span><br><span class="line"> 'paper.py', 'StringContain.py', 'tf_test.py'])]</span><br></pre></td></tr></table></figure>
<h2 id="找出所有图片文件"><a href="#找出所有图片文件" class="headerlink" title="找出所有图片文件"></a>找出所有图片文件</h2><p>上一步所找出的所有子目录，即为类别目录，类别目录下即为该类别的所有图片样本。通过一个文件类型匹配，可以避免目录中出现非图片文件而导致的异常。例如要求所有图片类型为<code>.jpg</code>：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">file_glob = <span class="string">'./images/A/*.jpg'</span></span><br><span class="line">image_list = tf.gfile.Glob(file_glob)</span><br></pre></td></tr></table></figure>
<p>这一匹配函数<code>tf.gfile.Glob()</code>，给出的文件名称次序是固定的，每次调用都不变。这一顺序和<code>os.listdir()</code>给出的次序是一样的。对于类似<code>A001.jpg, A002.jpg, ...</code>这种命名方式，其次序并不按照数字的大小。如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span>&gt;&gt; file_glob = '*.png'</span><br><span class="line"><span class="meta">&gt;</span>&gt;&gt; tf.gfile.Glob(file_glob)</span><br><span class="line">['./A3.png', './A11.png', './A10.png', './A8.png', './A6.png', './A9.png', './A12.png', './A5.png', './A16.png', './A7.png', './A15.png', './A2.png', './A1.png', './A13.png', './A14.png', './A4.png', './A0.png']</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span>&gt;&gt; os.listdir('.')</span><br><span class="line">['A3.png', 'A11.png', 'A10.png', 'A8.png', 'A6.png', 'A9.png', 'A12.png', 'A5.png', 'A16.png', 'A7.png', 'A15.png', 'A2.png', 'A1.png', 'A13.png', 'A14.png', 'A4.png', 'A0.png']</span><br></pre></td></tr></table></figure>
<p>这一排序方式可能是由文件系统（file system）决定的。</p>
<h2 id="将图片装入不同的集合"><a href="#将图片装入不同的集合" class="headerlink" title="将图片装入不同的集合"></a>将图片装入不同的集合</h2><p>在获取了每一类的<code>image_list</code>之后。接下来就要对每一类样本，都按训练集、测试集和验证集这三个集合分开。之后再将每一类的这三个集合组合起来，形成最终的训练集、测试集和验证集。对每一个样本文件，需要一个函数，来决定这个样本将进入哪个集合。这里采用了网上的一种方式（目前还不知道原作者是谁，网络上很多源代码都是这么干的）：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">training_images = []</span><br><span class="line">testing_images = []</span><br><span class="line">validation_images = []</span><br><span class="line">        </span><br><span class="line"><span class="keyword">for</span> file_name <span class="keyword">in</span> file_list: </span><br><span class="line">	<span class="comment"># e.g.</span></span><br><span class="line">    <span class="comment"># file_name: './images/0/0#1.jpg'</span></span><br><span class="line">    <span class="comment"># file_list: ['./images/0/0#1.jpg', './images/0/0#2.jpg', ...]</span></span><br><span class="line">            </span><br><span class="line">    hash_name = re.sub(<span class="string">r'_nohash_.*$'</span>, <span class="string">''</span>, file_name)</span><br><span class="line">    hash_name_hashed = hashlib.sha1(tf.compat.as_bytes(hash_name)).hexdigest()</span><br><span class="line">            </span><br><span class="line">    percentage_hash = ((int(hash_name_hashed, <span class="number">16</span>) % (MAX_NUM_IMAGES_PER_CLASS + <span class="number">1</span>)) * (<span class="number">100.0</span> / MAX_NUM_IMAGES_PER_CLASS))</span><br><span class="line">            </span><br><span class="line">    <span class="keyword">if</span> percentage_hash &lt; validation_percentage:</span><br><span class="line">		validation_images.append(file_name)</span><br><span class="line">	<span class="keyword">elif</span> percentage_hash &lt; (testing_percentage + validation_percentage):</span><br><span class="line">		testing_images.append(file_name)</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">        training_images.append(file_name)</span><br></pre></td></tr></table></figure>
<p>里面通过哈希编码，只根据样本的文件名（含路径），来确定该文件是进入哪个集合。而且在文件名不变的情况下，同一个样本在每次操作都将进入同一个集合，不论是否加入了新的样本。因为哈希编码的结果只和文件名（含路径）有关。在对每一类样本都分开三个集合之后，下面就要将不同类之间的小集合组合起来。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">analysis_image_lists</span><span class="params">(image_lists)</span>:</span></span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    Input: </span></span><br><span class="line"><span class="string">    - image_lists</span></span><br><span class="line"><span class="string">    e.g.</span></span><br><span class="line"><span class="string">    image_lists['A'] = &#123;</span></span><br><span class="line"><span class="string">            'training': ['./images/A/A001.jpg', ...],</span></span><br><span class="line"><span class="string">            'testing': ['./images/A/A002.jpg', ...],</span></span><br><span class="line"><span class="string">            'validation': ['./images/A/A005.jpg', ...],</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    Output: </span></span><br><span class="line"><span class="string">    - train_list</span></span><br><span class="line"><span class="string">    - test_list</span></span><br><span class="line"><span class="string">    - validation_list  </span></span><br><span class="line"><span class="string">    e.g. ['./images/A/A002.jpg', ...], ..., ...</span></span><br><span class="line"><span class="string">    '''</span>  </span><br><span class="line">    </span><br><span class="line">    train_list = []</span><br><span class="line">    test_list = []</span><br><span class="line">    validation_list = []</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> _, lists_dict <span class="keyword">in</span> image_lists.items():</span><br><span class="line">        </span><br><span class="line">        train_list.extend(lists_dict[<span class="string">'training'</span>])</span><br><span class="line">        test_list.extend(lists_dict[<span class="string">'testing'</span>])</span><br><span class="line">        validation_list.extend(lists_dict[<span class="string">'validation'</span>])</span><br><span class="line">    </span><br><span class="line">    random.shuffle(train_list)</span><br><span class="line">    random.shuffle(test_list)</span><br><span class="line">    random.shuffle(validation_list)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> train_list, test_list, validation_list</span><br></pre></td></tr></table></figure>
<p>这里是访问一个字典里的键值，我们知道python中的字典，内部是无序的。但是其实每次访问其中元素时，还是依照了一定的顺序，只不过不见得是放入时的顺序。这种访问次序，是由一个哈希算法决定的，这种哈希算法随着python版本的改变，以及操作平台的改变都会不同。</p>
<blockquote>
<p>Python dictionaries and sets are stored using some efficient hashing algorithm. The precise algorithm is an implementation detail (and may differ from one version of Python to another as well as one platform to another (CPython, vs. PyPy, vs Jython or IronPython, and so on).</p>
<p>Iterating over the keys returns them in whatever order the underlying implementation chose to store them. Hashing provides for extremely efficient access to an item given its key. This typically has the effect of making them appear to be in a “random” order by human standards.</p>
<p><a href="https://www.quora.com/In-Python-what-decides-the-order-that-a-loop-on-a-dictionary-works-through-the-keys" target="_blank" rel="noopener">参考链接</a>.</p>
</blockquote>
<p>所以至此来说，制作成的<code>TFRecords</code>文件中样本的顺序，在每次制作时就应该认为是不固定的了。那么看来就没必要保持每次制作数据集时样本的次序一致。在上面的函数中，干脆加入了<code>random.shuffle()</code>，来让它乱的彻底一点。<span style="border-bottom:2px dashed yellow;">实际上，在从数据集中取样本用来训练模型的时候，也就是要尽量以一种均匀分布的概率来抽取样本。所以没必要在制作数据集的时候保持样本次序的稳定。这也是我一开始的一个误解。</span>以上作为一个例子，目的是说明在每次形成三个数据集的<code>image_list</code>的时候，文件的顺序很可能因为文件名的原因而发生改变。而我们现在对图片文件的命名规则为<code>class_index#image_index.extension</code>.例如：<code>0#1.jpg</code>代表第<code>0</code>类中的第<code>1</code>张图片。这种命名规则下文件的顺序始终是数字大小顺序，不过前面也说了，不用保持这种次序的稳定性。</p>
<p>至此就制作好了训练集、测试集、验证集三个图片路径列表。</p>
<h1 id="读取TFRecords注意事项"><a href="#读取TFRecords注意事项" class="headerlink" title="读取TFRecords注意事项"></a>读取TFRecords注意事项</h1><p>这里主要关注函数<code>tf.data.Dataset.shuffle(buffer_size)</code>。针对这个函数，做两点说明。一个是关于参数<code>buffer_size</code>的取值；一个是该函数与<code>tf.data.Dataset.batch()</code>的先后次序问题。</p>
<h2 id="buffer-size的取值"><a href="#buffer-size的取值" class="headerlink" title="buffer_size的取值"></a>buffer_size的取值</h2><p>先来看<code>tf.data.Dataset.shuffle(buffer_size)</code>的工作过程：</p>
<ol>
<li>在所有样本中按次序取前<code>buffer_size</code>个样本放入buffer中。</li>
</ol>
<img src="/2019/03/20/创建与读取TFRecords文件/2.jpg">
<ol start="2">
<li>当读取数据时，每次从buffer中随机取出一个样本。</li>
</ol>
<img src="/2019/03/20/创建与读取TFRecords文件/3.jpg">
<ol start="3">
<li>当buffer中取走数据后，会从所有样本中再按次序取下一个样本放入buffer。</li>
</ol>
<img src="/2019/03/20/创建与读取TFRecords文件/4.jpg">
<p>这一函数的作用就是避免一次性将整个数据集读入内存，但又能有随机性的取样本。读入内存的为<code>buffer_size</code>个样本，且在buffer中取样本为随机的。<code>buffer_size</code>和数据集样本总数的相对大小，将会影响取样本的过程对整个数据集而言的随机性。</p>
<ul>
<li><p>buffer_size &gt;= 样本总数。那么此时整个数据集都会被放进buffer里，取样本时，对于整个数据集来说就是完全随机的。每个样本被选到的概率符合均匀分布。</p>
</li>
<li><p>buffer_size == 1。这相当于依次取样本，并没有随机性。</p>
</li>
</ul>
<p>以上是两种极端情况。那么其实还是没有回答应该如何取一个中间值，既避免因数据集过大而导致占用内存过多，又可以使样本的选取具有一定随机性。这种值的选取应该是要结合具体任务的。总之，要尽量保证一个<code>batch</code>的样本中，各类别样本数尽量平均。比如做猫和狗的图片分类，<code>batchsize = 32</code>，那么这其中大致应有16张猫的图片和16张狗的图片。<a href="https://user-gold-cdn.xitu.io/2018/8/28/16580f396628e48b" target="_blank" rel="noopener">参考链接</a>.</p>
<h2 id="Dataset-shuffle与Dataset-batch的顺序"><a href="#Dataset-shuffle与Dataset-batch的顺序" class="headerlink" title="Dataset.shuffle与Dataset.batch的顺序"></a>Dataset.shuffle与Dataset.batch的顺序</h2><p>除了<code>tf.data.Dataset.shuffle(buffer_size)</code>还有一个函数叫<code>tf.data.Dataset.batch(batch_size)</code>。这两个都是对数据集的一种操作。结论是<code>shuffle</code>应该在<code>batch</code>前面。因为如果先执行<code>tf.data.Dataset.batch()</code>，会在原数据集中，依次将每<code>batch_size</code>个样本作为一个整体输出。那么如果在此之前数据集并没有很好的打乱的话，按顺序把样本组合起来的话，可能会有<code>batch</code>中 样本类别分布不均匀的情况。以<a href="https://stackoverflow.com/questions/50437234/tensorflow-dataset-shuffle-then-batch-or-batch-then-shuffle" target="_blank" rel="noopener">参考链接</a>中的例子为例：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">tf.enable_eager_execution()  <span class="comment"># To simplify the example code.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Batch before shuffle.</span></span><br><span class="line">dataset = tf.data.Dataset.from_tensor_slices([<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>])</span><br><span class="line">dataset = dataset.batch(<span class="number">3</span>)</span><br><span class="line">dataset = dataset.shuffle(<span class="number">9</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> elem <span class="keyword">in</span> dataset:</span><br><span class="line">  print(elem)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Prints:</span></span><br><span class="line"><span class="comment"># tf.Tensor([1 1 1], shape=(3,), dtype=int32)</span></span><br><span class="line"><span class="comment"># tf.Tensor([2 2 2], shape=(3,), dtype=int32)</span></span><br><span class="line"><span class="comment"># tf.Tensor([0 0 0], shape=(3,), dtype=int32)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Shuffle before batch.</span></span><br><span class="line">dataset = tf.data.Dataset.from_tensor_slices([<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>])</span><br><span class="line">dataset = dataset.shuffle(<span class="number">9</span>)</span><br><span class="line">dataset = dataset.batch(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> elem <span class="keyword">in</span> dataset:</span><br><span class="line">  print(elem)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Prints:</span></span><br><span class="line"><span class="comment"># tf.Tensor([2 0 2], shape=(3,), dtype=int32)</span></span><br><span class="line"><span class="comment"># tf.Tensor([2 1 0], shape=(3,), dtype=int32)</span></span><br><span class="line"><span class="comment"># tf.Tensor([0 1 1], shape=(3,), dtype=int32)</span></span><br></pre></td></tr></table></figure>

      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/TensorFlow/" rel="tag"># TensorFlow</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/03/11/残差网络介绍与实现/" rel="next" title="残差网络介绍与实现">
                <i class="fa fa-chevron-left"></i> 残差网络介绍与实现
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/03/20/博客搭建前的困惑答疑/" rel="prev" title="博客搭建前的困惑答疑">
                博客搭建前的困惑答疑 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  
    <div class="comments" id="comments">
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar_square.png" alt="Jairo">
            
              <p class="site-author-name" itemprop="name">Jairo</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">12</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">7</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                  <a href="https://www.zhihu.com/people/Ja1r0/activities" title="知乎 &rarr; https://www.zhihu.com/people/Ja1r0/activities" rel="noopener" target="_blank">知乎</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                  <a href="https://weibo.com/u/5601451342" title="微博 &rarr; https://weibo.com/u/5601451342" rel="noopener" target="_blank">微博</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                  <a href="mailto:jairoyang@qq.com" title="邮件 &rarr; mailto:jairoyang@qq.com" rel="noopener" target="_blank">邮件</a>
                </span>
              
            </div>
          

          

          
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#遍历目录及文件"><span class="nav-number">1.</span> <span class="nav-text">遍历目录及文件</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#确定所有子目录"><span class="nav-number">1.1.</span> <span class="nav-text">确定所有子目录</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#找出所有图片文件"><span class="nav-number">1.2.</span> <span class="nav-text">找出所有图片文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#将图片装入不同的集合"><span class="nav-number">1.3.</span> <span class="nav-text">将图片装入不同的集合</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#读取TFRecords注意事项"><span class="nav-number">2.</span> <span class="nav-text">读取TFRecords注意事项</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#buffer-size的取值"><span class="nav-number">2.1.</span> <span class="nav-text">buffer_size的取值</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Dataset-shuffle与Dataset-batch的顺序"><span class="nav-number">2.2.</span> <span class="nav-text">Dataset.shuffle与Dataset.batch的顺序</span></a></li></ol></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Jairo</span>

  

  
</div>


  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v3.8.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a> v7.0.0</div>




        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="post-meta-item-icon">
      <i class="fa fa-user"></i>
    </span>
    <span class="site-uv" title="总访客量">
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
    </span>
  

  
    <span class="post-meta-divider">|</span>
  

  
    <span class="post-meta-item-icon">
      <i class="fa fa-eye"></i>
    </span>
    <span class="site-pv" title="总访问量">
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
    </span>
  
</div>









        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/src/utils.js?v=7.0.0"></script>

  <script src="/js/src/motion.js?v=7.0.0"></script>



  
  


  <script src="/js/src/schemes/muse.js?v=7.0.0"></script>




  
  <script src="/js/src/scrollspy.js?v=7.0.0"></script>
<script src="/js/src/post-details.js?v=7.0.0"></script>



  


  <script src="/js/src/bootstrap.js?v=7.0.0"></script>


  
  
  

<script src="//cdn1.lncld.net/static/js/3.11.1/av-min.js"></script>



<script src="//unpkg.com/valine/dist/Valine.min.js"></script>

<script>
  var GUEST = ['nick', 'mail', 'link'];
  var guest = 'nick,mail,link';
  guest = guest.split(',').filter(function(item) {
    return GUEST.indexOf(item) > -1;
  });
  new Valine({
    el: '#comments',
    verify: false,
    notify: false,
    appId: '9IIUquKAB8dC33rTPetpM2J0-gzGzoHsz',
    appKey: '2VD0aGQxj9ligzFy97AIn5h9',
    placeholder: '让我听到你的声音~',
    avatar: 'mm',
    meta: guest,
    pageSize: '10' || 10,
    visitor: false
  });
</script>




  


  




  

  

  
  

  
  

  


  

  

  

  

  

  

  

  

  

  

  
<div id="hexo-helper-live2d">
  <canvas id="live2dcanvas" width="150" height="300"></canvas>
</div>
<style>
  #live2dcanvas{
    position: fixed;
    width: 150px;
    height: 300px;
    opacity:1;
    left: 0px;
    z-index: 999;
    pointer-events: none;
    bottom: -50px;
  }
</style>
<script type="text/javascript" src="/live2d/device.min.js"></script>
<script type="text/javascript">
const loadScript = function loadScript(c,b){var a=document.createElement("script");a.type="text/javascript";"undefined"!=typeof b&&(a.readyState?a.onreadystatechange=function(){if("loaded"==a.readyState||"complete"==a.readyState)a.onreadystatechange=null,b()}:a.onload=function(){b()});a.src=c;document.body.appendChild(a)};
(function(){
  if((typeof(device) != 'undefined') && (device.mobile())){
    document.getElementById("live2dcanvas").style.width = '75px';
    document.getElementById("live2dcanvas").style.height = '150px';
  }else
    if (typeof(device) === 'undefined') console.error('Cannot find current-device script.');
  loadScript("/live2d/script.js", function(){loadlive2d("live2dcanvas", "/live2d/assets/hijiki.model.json", 0.5);});
})();
</script>

</body>
</html>
<!-- 页面点击小红心 -->
<script type="text/javascript" src="/js/src/clicklove.js"></script>
